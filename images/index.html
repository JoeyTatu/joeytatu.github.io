<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Sky TV Guide - Channels</title>
  <link rel="icon" type="image/x-icon" href="images/fav-icon.ico">
  <link rel="stylesheet" href="style.css">

  <style>
    /* Hide Now & Next under 500px */
    @media (max-width: 500px) {
      .mini-epg {
        display: none !important;
      }
    }

    /* Wrap Now/Next text instead of truncating */
    .mini-epg div {
      white-space: normal;
      /* allow wrapping */
      overflow-wrap: break-word;
      /* break long words if needed */
      word-break: break-word;
      /* ensure wrapping even for long strings */
      max-width: 100%;
      margin-bottom: 2px;
      /* optional spacing between lines */
    }

    /* Make Now & Next text white in dark mode */
    body.dark-mode .mini-epg {
      color: #e6e6e6 !important;
    }

    /* Optional: widen channel name area to avoid overlap */
    .channel-name {
      min-width: 180px;
      display: inline-block;
    }

    /* Center all category headings */
    .channel-category h3 {
      text-align: center;
    }

    /* Channels side-by-side by default */
    .channels-container {
      display: flex;
      gap: 20px;
      /* spacing between columns */
    }

    /* Make it stack vertically when window is ‚â§ 952px */
    @media (max-width: 952px) {
      .channels-container {
        flex-direction: column;
      }

      .channel-column {
        width: 100%;
        /* full width for each column */
      }
    }
  </style>
</head>

<body>
  <button id="theme-toggle" aria-label="Toggle dark mode">
    üåô<br><span class="theme-label">DARK MODE</span>
  </button>

  <header>
    <a href="index.html">
      <img src="images/logo.svg" alt="ViewersVault Logo" class="header-logo">
    </a>
    <br>
    <button id="channel-list" onclick="location.href='https://viewersvault.com'">
      &larr;<br>Return to ViewersVault.com
    </button>

    <h1>Sky TV Guide - Channels</h1>
    <p>TV listings for Sky in the United Kingdom and Ireland</p>
    <p>Channels listed here adhere to the Sky Q EPG.<br>
      <small>with the exception of TNT Sports 5‚Äì10 and GINX Esports TV HD,<br>
        which follow the Sky Glass & Stream EPG</small>
    </p>
    <p>Select a channel to view listings</p>

    <div id="search-container">
      <input type="text" id="search-input" placeholder="üîé Search for channels...">
      <button id="clear-search" style="display: none;">‚úñ</button>
    </div>
  </header>

  <main class="channels-container">
    <section class="channel-column" id="uk-column">
      <h2 style="text-align:center;">United Kingdom</h2>
      <div id="channels-uk-list" class="channels-list"></div>
    </section>

    <section class="channel-column" id="ireland-column">
      <h2 style="text-align:center;">Ireland</h2>
      <div id="channels-ireland-list" class="channels-list"></div>
    </section>
  </main>

  <footer>
    <small>&copy; <span id="footer-year"></span> ViewersVault.com ‚Äî All Rights Reserved ‚Äî üìß
      <a href="mailto:admin@viewersvault.com">admin@viewersvault.com</a>
    </small>
  </footer>

  <script>
    // ==========================
    // Footer year auto-update
    // ==========================
    const startYear = 2025;
    const currentYear = new Date().getFullYear();
    const yearText = currentYear === startYear ? `${startYear}` : `${startYear}-${currentYear}`;
    document.getElementById('footer-year').textContent = yearText;

    // ==========================
    // Channel Categories
    // ==========================
    const categories = [
      { name: "Entertainment & Documentaries", min: 100, max: 199 },
      { name: "Entertainment & Documentaries +1", min: 201, max: 299 },
      { name: "Movies", min: 300, max: 339 },
      { name: "HD Entertainment & Documentaries", min: 340, max: 349 },
      { name: "Music", min: 350, max: 399 },
      {
        name: "Sports",
        custom: n => (n >= 401 && n <= 499 && n !== 493) || (n >= 3006 && n <= 3011),
      },
      { name: "News", min: 501, max: 579 },
      { name: "Religion", min: 580, max: 599 },
      { name: "Kids", min: 601, max: 659 },
      { name: "Shopping", min: 660, max: 699 },
      { name: "International", min: 701, max: 799 },
      {
        name: "Secondary",
        custom: n => (n >= 801 && n <= 856) || (n >= 859 && n <= 898)
      },
      { name: "Regional & Interactive", min: 951, max: 979 },
      {
        name: "Information",
        custom: n => n === 899 || n === 950 || n === 998
      },
      { name: "Radio", min: 3101, max: 3250, isRadio: true },
    ];

    // ==========================
    // Utilities
    // ==========================
    function getFirstNumber(c) {
      if (typeof c.number === "number") return c.number;
      if (typeof c.number === "string") {
        const match = c.number.match(/\d+/);
        return match ? parseInt(match[0], 10) : NaN;
      }
      return NaN;
    }

    function formatChannelNumber(number, isRadio = false) {
      // If number is an integer, handle normally
      if (Number.isInteger(number)) {
        if (isRadio && number >= 3101 && number <= 3250) {
          return "0" + number.toString().slice(1);
        }
        return number;
      }

      // If number is a string that is purely digits, convert to number
      if (typeof number === "string" && /^\d+$/.test(number)) {
        let num = parseInt(number, 10);
        if (isRadio && num >= 3101 && num <= 3250) {
          return "0" + num.toString().slice(1);
        }
        return num;
      }

      // Otherwise, treat as HTML and return as-is
      return number;
    }

    // ==========================
    // Render channels grouped by category
    // ==========================
    async function renderChannels(jsonFile, containerId, region) {
      try {
        const res = await fetch(jsonFile);
        const channels = await res.json();
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        for (const cat of categories) {
          let catChannels = [];

          if (cat.custom) {
            catChannels = channels.filter(c => {
              const n = getFirstNumber(c);
              return cat.custom(n);
            });
          } else {
            catChannels = channels.filter(c => {
              const n = getFirstNumber(c);
              return n >= cat.min && n <= cat.max;
            });
          }

          if (!catChannels.length) continue;

          const section = document.createElement("section");
          section.classList.add("channel-category");
          section.innerHTML = `<h3>${cat.name}</h3><ul></ul>`;
          const ul = section.querySelector("ul");

          for (const ch of catChannels) {
            const li = document.createElement("li");
            li.innerHTML = `
              <a href="listings.html?sid=${ch.sid}" class="channel-link">
                <span class="channel-number">${formatChannelNumber(ch.number, cat.isRadio)}</span>
                ${ch.logo ? `<img src="${ch.logo}" alt="${ch.name} logo" class="channel-logo">` : ""}
                <span class="channel-name">
                  ${ch.name}
                  <div class="mini-epg" id="epg-${ch.sid}-${region}" style="font-size: 13px; color: #555; margin-top: 4px;">
                    <em>Click for listings\u2026</em>
                  </div>
                </span>
              </a>
            `;
            ul.appendChild(li);
          }

          container.appendChild(section);
        }

        return channels;
      } catch (err) {
        console.error(`Error rendering channels from ${jsonFile}:`, err);
        return [];
      }
    }

    // ==========================
    // Load Now & Next sequentially
    // ==========================
    async function loadEPGSequential(channels, region) {
      for (const ch of channels) {
        if (!ch.sid) continue;
        await loadMiniEPG(ch.sid, region);
      }
    }

    // ==========================
    // Mini EPG Fetcher
    // ==========================
    async function loadMiniEPG(sid, region) {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
      const url = `https://awk.epgsky.com/hawk/linear/schedule/${dateStr}/${sid}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const events = data?.schedule?.[0]?.events || [];
        const container = document.getElementById(`epg-${sid}-${region}`);
        if (!container) return;

        if (!events.length) {
          container.innerHTML = `<em>No listings</em>`;
          return;
        }

        const now = Math.floor(Date.now() / 1000);
        const current = events.find(e => e.st <= now && now < e.st + e.d) || events[0];
        const next = events.find(e => e.st > now);

        const formatTime = ts => {
          const d = new Date(ts * 1000);
          return d.toISOString().substr(11, 5);
        };

        // const truncate40 = str => str && str.length > 40 ? str.slice(0, 40) + "\u2026" : str;

        // container.innerHTML = `
        //   <div class="epg-now">Now - ${formatTime(current.st)}: ${truncate40(current.t || "Click for listings...")}</div>
        //   ${next ? `<div class="epg-next">Next - ${formatTime(next.st)}: ${truncate40(next.t)}</div>` : ""}
        // `;

        container.innerHTML = `
          <div class="epg-now">Now - ${formatTime(current.st)}: ${(current.t || "Click for listings\u2026")}</div>
          ${next ? `<div class="epg-next">Next - ${formatTime(next.st)}: ${(next.t)}</div>` : ""}
        `;
      } catch (err) {
        const container = document.getElementById(`epg-${sid}-${region}`);
        if (container) container.innerHTML = `<em>Unavailable</em>`;
      }
    }

    // ==========================
    // Load both UK and Ireland
    // ==========================
    async function loadBothRegions() {
      const [ukChannels, ieChannels] = await Promise.all([
        renderChannels("channels-uk.json", "channels-uk-list", "uk"),
        renderChannels("channels-ireland.json", "channels-ireland-list", "ie")
      ]);

      await Promise.all([
        loadEPGSequential(ukChannels, "uk"),
        loadEPGSequential(ieChannels, "ie")
      ]);
    }

    loadBothRegions();

    // ==========================
    // Search
    // ==========================
    function normalizeText(text) {
      return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    const searchInput = document.getElementById("search-input");
    const clearBtn = document.getElementById("clear-search");

    searchInput.addEventListener("input", () => {
      const filter = normalizeText(searchInput.value.trim());
      clearBtn.style.display = filter ? "block" : "none";

      ["channels-uk-list", "channels-ireland-list"].forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;

        const sections = container.querySelectorAll(".channel-category");
        let anyVisible = false;

        sections.forEach(section => {
          const items = section.querySelectorAll("li");
          let visibleCount = 0;

          items.forEach(li => {
            const text = normalizeText(li.textContent);
            const visible = !filter || text.includes(filter);
            li.style.display = visible ? "" : "none";
            if (visible) visibleCount++;
          });

          section.style.display = visibleCount ? "" : "none";
          if (visibleCount) anyVisible = true;
        });

        container.style.display = anyVisible ? "" : "none";
      });
    });

    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      clearBtn.style.display = "none";
      searchInput.dispatchEvent(new Event("input"));
    });

    // =====================
    // Theme Toggle
    // =====================
    const toggleButton = document.getElementById("theme-toggle");
    const userPref = localStorage.getItem("theme");

    if (userPref === "dark") {
      document.body.classList.add("dark-mode");
      toggleButton.textContent = "‚òÄÔ∏è<br>DARK MODE";
    }

    toggleButton.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      toggleButton.innerHTML = isDark
        ? '‚òÄÔ∏è<br><span class="theme-label">LIGHT MODE</span>'
        : 'üåô<br><span class="theme-label">DARK MODE</span>';
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
  </script>
</body>

</html>